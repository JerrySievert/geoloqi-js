<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="easyXDM/easyXDM.debug.js"></script>
    <script src="easyXDM/json2.min.js"></script>
    <script type="text/javascript">
      var geoloqiReceiver = (function() {
        var apiUrl = 'https://api.geoloqi.com/1/';
        var version = '0.0.1'
        var exports = {};

        var socket = new easyXDM.Socket({
          onMessage: function(message, origin) {

            var request = JSON.parse(message);

            geoloqiReceiver.execute(request, function(payload) {
              payload.callbackId = request.callbackId;
              socket.postMessage(JSON.stringify(payload), origin);
            });
          }
        });

        function execute(o, callback) {
          var headers = {'Content-Type': 'application/json',
                         'X-Geoloqi-Version': 'geoloqi-client-js '+o.version+' receiver '+version,
                         'Accept': 'application/json'},
              xhr = util.getXHR(),
              payload = {};

          if(typeof(o.accessToken) === 'string') {
            headers['Authorization'] = 'OAuth '+o.accessToken;
          }

          xhr.onreadystatechange = function(){

            if (4 === xhr.readyState) {

              if (xhr.status === 200) {
                payload.response = xhr.responseText;
              } else {
                payload.error = {status: xhr.status, message: xhr.responseText};
              }

              callback(payload);
            }

          };

          var fullUrl = apiUrl+o.path;

          xhr.open(o.method, fullUrl, true);

          // set header fields
          for (var field in headers) {
            xhr.setRequestHeader(field, headers[field]);
          }

          if (o.method === 'POST') {
            xhr.send(JSON.stringify(o.args));
          } else {
            xhr.send();
          }
        }
        exports.execute = execute;

        var util = {};
        util.getXHR = function() {
          if (window.XMLHttpRequest
            && ('file:' != window.location.protocol || !window.ActiveXObject)) {
            return new XMLHttpRequest;
          } else {
            try {
              return new ActiveXObject('Microsoft.XMLHTTP');
            } catch(e) {}
            try {
              return new ActiveXObject('Msxml2.XMLHTTP.6.0');
            } catch(e) {}
            try {
              return new ActiveXObject('Msxml2.XMLHTTP.3.0');
            } catch(e) {}
            try {
              return new ActiveXObject('Msxml2.XMLHTTP');
            } catch(e) {}
          }
          return false;
        }

        return exports;
      }());
    </script>
  </head>
  <body></body>
</html>
